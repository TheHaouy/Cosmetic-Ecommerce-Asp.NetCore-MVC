@model Final_VS1.Data.TaiKhoan
@{
    ViewData["Title"] = "Chi Tiết Khách Hàng";
    ViewData["PageTitle"] = "Chi Tiết Khách Hàng";
}

<div class="container-fluid py-4 fade-in">
    <div class="mb-3">
        <a href="@Url.Action("Index", "Khachhang")" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Quay lại danh sách
        </a>
    </div>

    <div class="row">
        <!-- Left Column - Customer Info -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <div class="detail-avatar-wrapper mb-3">
                        @if (!string.IsNullOrEmpty(Model.AnhDaiDien))
                        {
                            <img src="@Model.AnhDaiDien" alt="Avatar" 
                                 class="rounded-circle detail-avatar-img">
                        }
                        else
                        {
                            <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center detail-avatar-img"
                                 style="font-size: 48px;">
                                <i class="fas fa-user"></i>
                            </div>
                        }
                        @if (Model.TrangThai != true)
                        {
                            <span class="lock-indicator-lg"><i class="fas fa-lock"></i></span>
                        }
                    </div>
                    
                    <h5 class="mb-1">@(Model.HoTen ?? "Chưa cập nhật")</h5>
                    <p class="text-muted">Khách hàng</p>
                    
                    @if (Model.TrangThai == true)
                    {
                        <span class="badge bg-success">Hoạt động</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">Bị khóa</span>
                    }

                    <div class="mt-3 w-100 text-start">
                        <label class="form-label small text-muted">Ghi chú (tùy chọn)</label>
                        <textarea class="form-control mb-2" id="lockNote" rows="2" placeholder="Lý do khóa/mở khóa (bắt buộc khi khóa)"></textarea>
                        <button type="button" id="toggleLockBtn"
                                class="btn @(Model.TrangThai == true ? "btn-outline-danger" : "btn-outline-success") w-100"
                                data-status="@(Model.TrangThai == true ? "active" : "locked")">
                            <i class="fas @(Model.TrangThai == true ? "fa-user-lock" : "fa-lock-open") me-2"></i>
                            @(Model.TrangThai == true ? "Khóa tài khoản" : "Mở khóa tài khoản")
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-info-circle" style="color: var(--primary-color);"></i> Thông tin cá nhân
                    </h6>

                    <div class="info-row">
                        <div class="info-label">Email</div>
                        <div class="info-value">@Model.Email</div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.SoDienThoai))
                    {
                        <div class="info-row">
                            <div class="info-label">SĐT</div>
                            <div class="info-value">@Model.SoDienThoai</div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model.GioiTinh))
                    {
                        <div class="info-row">
                            <div class="info-label">Giới tính</div>
                            <div class="info-value">@Model.GioiTinh</div>
                        </div>
                    }

                    @if (Model.NgaySinh.HasValue)
                    {
                        <div class="info-row">
                            <div class="info-label">Ngày sinh</div>
                            <div class="info-value">@Model.NgaySinh.Value.ToString("dd/MM/yyyy")</div>
                        </div>
                    }

                    <div class="info-row">
                        <div class="info-label">Ngày tham gia</div>
                        <div class="info-value">
                            @(Model.NgayTao.HasValue ? Model.NgayTao.Value.ToString("dd/MM/yyyy") : "N/A")
                        </div>
                    </div>
                </div>
            </div>

            <!-- Addresses -->
            @if (Model.DiaChis.Any())
            {
                <div class="card mt-3">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-map-marker-alt" style="color: var(--primary-color);"></i> Địa chỉ
                        </h6>
                        @foreach (var address in Model.DiaChis)
                        {
                            <div class="mb-3 p-3 bg-light rounded">
                                <strong>@address.HoTenNguoiNhan</strong>
                                @if (address.MacDinh == true)
                                {
                                    <span class="badge bg-primary small">Mặc định</span>
                                }
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-phone"></i> @address.SoDienThoai
                                </small>
                                <br>
                                <small>@address.DiaChiChiTiet</small>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Right Column - Order History -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-shopping-cart" style="color: var(--primary-color);"></i> Lịch sử đơn hàng (@Model.DonHangs.Count)
                    </h5>

                    @if (Model.DonHangs.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Mã đơn</th>
                                        <th>Ngày đặt</th>
                                        <th>Sản phẩm</th>
                                        <th>Tổng tiền</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var order in Model.DonHangs.OrderByDescending(d => d.NgayDat))
                                    {
                                        <tr>
                                            <td><strong>#@order.IdDonHang</strong></td>
                                            <td>@order.NgayDat?.ToString("dd/MM/yyyy")</td>
                                            <td>@order.ChiTietDonHangs.Count SP</td>
                                            <td class="fw-bold" style="color: var(--primary-color);">@((order.TongTien ?? 0).ToString("N0"))₫</td>
                                            <td>
                                                @{
                                                    var badgeClass = order.TrangThai switch
                                                    {
                                                        "Chờ xác nhận" => "bg-warning text-dark",
                                                        "Đã xác nhận" => "bg-info",
                                                        "Đang giao hàng" => "bg-primary",
                                                        "Hoàn thành" => "bg-success",
                                                        "Đã hủy" => "bg-danger",
                                                        _ => "bg-secondary"
                                                    };
                                                }
                                                <span class="badge @badgeClass">@order.TrangThai</span>
                                            </td>
                                            <td>
                                                <a href="@Url.Action("Detail", "Donhang", new { id = order.IdDonHang })" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-shopping-cart fa-3x mb-3 text-gradient"></i>
                            <p>Khách hàng chưa có đơn hàng nào</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #6c757d;
        }

        .info-value {
            text-align: right;
        }

        .detail-avatar-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .detail-avatar-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
        }

        .lock-indicator-lg {
            position: absolute;
            right: -10px;
            bottom: -10px;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #dc3545;
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border: 3px solid #fff;
        }
    </style>
}

@section Scripts {
    @Html.AntiForgeryToken()
    <script>
        $(document).ready(function () {
            const token = $('input[name="__RequestVerificationToken"]').val();

            $('#toggleLockBtn').on('click', function () {
                const isActive = $(this).data('status') === 'active';
                const note = $('#lockNote').val();
                const actionText = isActive ? 'khóa' : 'mở khóa';

                if (isActive && (!note || !note.trim())) {
                    Swal.fire('Thiếu ghi chú', 'Vui lòng nhập lý do khi khóa tài khoản.', 'warning');
                    return;
                }

                Swal.fire({
                    title: 'Xác nhận',
                    text: `Bạn chắc chắn muốn ${actionText} tài khoản này?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (!result.isConfirmed) return;

                    $.ajax({
                        url: '@Url.Action("ToggleLock", "Khachhang", new { area = "NhanVien" })',
                        type: 'POST',
                        data: {
                            id: @Model.IdTaiKhoan,
                            lockAccount: isActive,
                            note: note,
                            __RequestVerificationToken: token
                        },
                        success: function (response) {
                            if (response.success) {
                                Swal.fire('Thành công', response.message, 'success').then(() => location.reload());
                            } else {
                                Swal.fire('Lỗi', response.message, 'error');
                            }
                        },
                        error: function () {
                            Swal.fire('Lỗi', 'Không thể cập nhật trạng thái tài khoản', 'error');
                        }
                    });
                });
            });
        });
    </script>
}
