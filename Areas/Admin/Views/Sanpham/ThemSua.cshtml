@model Final_VS1.Data.SanPham
@{
    ViewData["Title"] = Model.IdSanPham == 0 ? "Thêm sản phẩm mới" : "Chỉnh sửa sản phẩm";
    ViewData["PageTitle"] = Model.IdSanPham == 0 ? "THÊM SẢN PHẨM MỚI" : "CHỈNH SỬA SẢN PHẨM";
    var danhMucs = (ViewBag.DanhMucs as List<Final_VS1.Data.DanhMuc>) ?? new List<Final_VS1.Data.DanhMuc>();
    var isNewProduct = Model.IdSanPham == 0;
}

<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                @{
                    var backUrl = isNewProduct 
                        ? Url.Action("Index", "Sanpham", new { area = "Admin" })
                        : (!string.IsNullOrEmpty(Model.Slug)
                            ? Url.RouteUrl("admin_product_details", new { slug = Model.Slug })
                            : Url.Action("ChiTiet", "Sanpham", new { id = Model.IdSanPham, area = "Admin" }));
                }
                <a href="@backUrl" class="btn btn-outline-secondary btn-sm bg-white">
                    <i class="fas fa-arrow-left me-1"></i>@(isNewProduct ? "Quay lại" : "Quay lại chi tiết")
                </a>
                <div class="vr"></div>
                <h5 class="mb-0">
                    <i class="fas fa-box me-2"></i>
                    @(isNewProduct ? "Thêm sản phẩm mới" : "Chỉnh sửa sản phẩm")
                </h5>
            </div>
            @if (!isNewProduct)
            {
                <a href="@Url.Action("QuanLyBienThe", "Sanpham", new { id = Model.IdSanPham, area = "Admin" })" class="btn btn-primary btn-sm">
                    <i class="fas fa-cog me-1"></i>Quản lý biến thể
                </a>
            }
        </div>
    </div>
    <div class="card-body">
        <form id="addEditProductForm" method="post" asp-action="@(isNewProduct ? "Create" : "Update")" asp-controller="Sanpham" asp-area="Admin" autocomplete="off">
            @if (!isNewProduct)
            {
                <input type="hidden" name="id" value="@Model.IdSanPham" />
                <input type="hidden" name="IdSanPham" value="@Model.IdSanPham" />
                <input type="hidden" name="NgayTao" value="@Model.NgayTao?.ToString("yyyy-MM-ddTHH:mm:ss")" />
            }
            @Html.AntiForgeryToken()
            
            <div class="row">
                <!-- Cột trái: Thông tin sản phẩm -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="tenSanPham" class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                        <input type="text" id="tenSanPham" name="TenSanPham" class="form-control" value="@Model.TenSanPham" required />
                    </div>
                    <div class="mb-3">
                        <label for="moTa" class="form-label">Mô tả</label>
                        <textarea id="moTa" name="MoTa" class="form-control summernote">@Model.MoTa</textarea>
                        <small class="text-muted">Sử dụng các công cụ để định dạng văn bản (in đậm, in nghiêng, màu sắc, kích thước...)</small>
                    </div>
                    <!-- Giá bán đã chuyển sang biến thể -->
                    <div class="mb-3">
                        <label for="danhMuc" class="form-label">Danh mục <span class="text-danger">*</span></label>
                        <select id="danhMuc" name="IdDanhMuc" class="form-select" required>
                            <option value="">-- Chọn danh mục --</option>
                            @foreach (var dm in danhMucs)
                            {
                                if (Model.IdDanhMuc == dm.IdDanhMuc)
                                {
                                    <option value="@dm.IdDanhMuc" selected>@dm.TenDanhMuc</option>
                                }
                                else
                                {
                                    <option value="@dm.IdDanhMuc">@dm.TenDanhMuc</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="trangThai" class="form-label">Trạng thái</label>
                        <select id="trangThai" name="TrangThai" class="form-select">
                            @if (Model.TrangThai == true)
                            {
                                <option value="true" selected>Đang bán</option>
                                <option value="false">Ngừng bán</option>
                            }
                            else
                            {
                                <option value="true">Đang bán</option>
                                <option value="false" selected>Ngừng bán</option>
                            }
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="slug" class="form-label">
                            Slug (URL thân thiện) 
                            <span class="text-danger">*</span>
                            <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" title="Slug là phần URL hiển thị trên thanh địa chỉ. VD: kem-duong-da-mat"></i>
                        </label>
                        <div class="input-group">
                            <input type="text" id="slug" name="Slug" class="form-control" value="@Model.Slug" placeholder="vi-du-slug" required />
                            <button type="button" class="btn btn-outline-secondary" id="btnGenerateSlug">
                                <i class="fas fa-sync-alt"></i> Tạo từ tên
                            </button>
                        </div>
                        <small class="text-muted">Chỉ cho phép chữ thường, số và dấu gạch ngang (-)</small>
                        @if (!isNewProduct)
                        {
                            <small class="text-warning d-block mt-1">
                                <i class="fas fa-exclamation-triangle"></i> Cẩn thận: Thay đổi slug sẽ làm các link cũ không hoạt động!
                            </small>
                        }
                        <div id="slugValidation" class="mt-1"></div>
                    </div>
                    
                </div>
                
                <!-- Cột phải: Hình ảnh sản phẩm -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Hình ảnh sản phẩm</label>
                        <div class="border p-3 bg-light rounded mb-3">
                            <input type="file" class="form-control mb-2" id="imageUpload" name="ImageFiles" multiple accept="image/*" />
                            <small class="text-muted">Chọn nhiều ảnh (Ctrl+Click). Định dạng: JPG, PNG, GIF, WebP. Tối đa 5MB/ảnh.</small>
                        </div>

                        <div id="imagePreviewContainer" style="max-height: 400px;max-width: 700px; overflow-y: auto;">
                            <div class="row" id="imagePreview">
                                @if (Model.AnhSanPhams != null && Model.AnhSanPhams.Any())
                                {
                                    string[] mainImageTypes = new[] { "Chính", "Chinh", "Primary", "Main" };
                                    foreach (var img in Model.AnhSanPhams)
                                    {
                                        var isMainImage = !string.IsNullOrEmpty(img.LoaiAnh) && mainImageTypes.Contains(img.LoaiAnh, StringComparer.OrdinalIgnoreCase);
                                        <div class="col-md-6 mb-2 image-item" data-url="@img.DuongDan">
                                            <div class="card h-100">
                                                <div class="position-relative">
                                                    <img src="@img.DuongDan" class="card-img-top" style="height: 100px; object-fit: cover;" 
                                                         onerror="this.src='/images/noimage.jpg'" loading="lazy">
                                                    <span class="position-absolute top-0 end-0 badge bg-success m-1 main-indicator" style="display: @(isMainImage ? "block" : "none");">Ảnh chính</span>
                                                </div>
                                                <div class="card-body p-2">
                                                    <div class="form-check mb-1">
                                                        <input class="form-check-input main-image" type="radio" name="MainImageUrl" value="@img.DuongDan" @(isMainImage ? "checked" : "")>
                                                        <label class="form-check-label small">Ảnh chính</label>
                                                    </div>
                                                    <input type="hidden" name="ExistingImages" value="@img.DuongDan" />
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-image w-100">
                                                        <i class="fas fa-trash me-1"></i>Xóa
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            <div id="noImagesMessage" class="alert alert-info @(Model.AnhSanPhams != null && Model.AnhSanPhams.Any() ? "d-none" : "")">
                                <i class="fas fa-info-circle me-2"></i>Chưa có ảnh nào. Hãy thêm ảnh cho sản phẩm.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-end mt-4 border-top pt-3">
                <a href="@backUrl" class="btn btn-secondary me-2">
                    <i class="fas fa-times me-1"></i>Hủy
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-save me-1"></i>Lưu sản phẩm
                </button>
            </div>
        </form>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/Admin/sanpham-index.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/Admin/sanpham-themsua.css" asp-append-version="true" />
    <!-- Summernote CSS -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
}

@section Scripts {
    <!-- Summernote JS -->
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-vi-VN.min.js"></script>
    
    <script>
        window.productUrls = {
                addAttribute: '@Url.Action("AddAttribute", "Thuoctinh", new { area = "Admin" })',
                addAttributeValue: '@Url.Action("AddAttributeValue", "Thuoctinh", new { area = "Admin" })',
                getAttributesWithValues: '@Url.Action("GetAttributesWithValues", "Thuoctinh", new { area = "Admin" })'
        };
    </script>
    <script>
        $(document).ready(function() {
            // Khởi tạo Summernote
            $('#moTa').summernote({
                placeholder: 'Nhập mô tả sản phẩm...',
                tabsize: 2,
                height: 200,
                lang: 'vi-VN',
                toolbar: [
                    ['style', ['style']],
                    ['font', ['bold', 'italic', 'underline', 'strikethrough', 'clear']],
                    ['fontname', ['fontname']],
                    ['fontsize', ['fontsize']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['height', ['height']],
                    ['table', ['table']],
                    ['insert', ['link']],
                    ['view', ['fullscreen', 'codeview', 'help']]
                ],
                fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'Helvetica', 'Impact', 'Tahoma', 'Times New Roman', 'Verdana'],
                fontNamesIgnoreCheck: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New'],
                fontSizes: ['8', '9', '10', '11', '12', '14', '16', '18', '20', '24', '28', '32', '36', '48', '64', '72'],
                callbacks: {
                    onInit: function() {
                        // Có thể thêm custom callback nếu cần
                    }
                }
            });
            
            $('#tenSanPham').focus();
            
            // Load danh sách thuộc tính và giá trị
            loadAttributesWithValues();
            
            // Xử lý định dạng giá khi nhập
            $('#giaBan').on('input', function() {
                const value = parseFloat($(this).val()) || 0;
                const $currentPrice = $(this).closest('.mb-3').find('.current-price');
                
                if (value > 0) {
                    if ($currentPrice.length === 0) {
                        $(this).closest('.input-group').after(`
                            <small class="text-muted current-price">
                                Giá đang nhập: <strong class="text-primary">${value.toLocaleString('vi-VN')} VNĐ</strong>
                            </small>
                        `);
                    } else {
                        $currentPrice.html(`Giá đang nhập: <strong class="text-primary">${value.toLocaleString('vi-VN')} VNĐ</strong>`);
                    }
                } else {
                    $currentPrice.remove();
                }
            });

            // Focus và select text khi click vào input giá
            $('#giaBan').on('focus', function() {
                $(this).select();
            });

            // Xử lý tải ảnh lên với validation
            $('#imageUpload').on('change', function(e) {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    const validFiles = files.filter(file => {
                        if (!file.type.startsWith('image/')) {
                            showAlert(`File "${file.name}" không phải là ảnh.`, 'warning');
                            return false;
                        }
                        if (file.size > 5 * 1024 * 1024) {
                            showAlert(`File "${file.name}" quá lớn. Kích thước tối đa là 5MB.`, 'warning');
                            return false;
                        }
                        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                        if (!allowedTypes.includes(file.type)) {
                            showAlert(`File "${file.name}" không đúng định dạng.`, 'warning');
                            return false;
                        }
                        return true;
                    });
                    
                    validFiles.forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            addImagePreview(e.target.result, index === 0 && $('.image-item').length === 0);
                        };
                        reader.onerror = function() {
                            showAlert(`Không thể đọc file: ${file.name}`, 'error');
                        };
                        reader.readAsDataURL(file);
                    });
                }
            });

            // Xử lý xóa ảnh
            $(document).on('click', '.remove-image', function(e) {
                e.preventDefault();
                const $imageItem = $(this).closest('.image-item');
                const wasMainImage = $imageItem.find('.main-image').is(':checked');
                
                $imageItem.remove();
                
                if (wasMainImage && $('.image-item').length > 0) {
                    $('.main-image').first().prop('checked', true);
                    updateMainImageIndicators();
                }
                
                updateNoImagesMessage();
            });

            // Xử lý thay đổi ảnh chính
            $(document).on('change', '.main-image', function() {
                var selectedUrl = $(this).val();
                console.log('Main image changed to:', selectedUrl);
                console.log('All images:', $('.image-item').map(function() { return $(this).data('url'); }).get());
                console.log('All radio values:', $('.main-image').map(function() { return this.value; }).get());
                console.log('Checked radio:', $('.main-image:checked').val());
                updateMainImageIndicators();
            });

            // Ngăn chặn double-click cho nút submit
            $('#submitBtn').on('click', function(e) {
                const $btn = $(this);
                if ($btn.prop('disabled') || $btn.data('clicking')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    return false;
                }
                $btn.data('clicking', true);
                setTimeout(() => $btn.data('clicking', false), 1000);
            });

            // Functions
            function addImagePreview(imageUrl, setAsMain = false) {
                const imageContainer = $('#imagePreview');
                
                const imageItem = $(`
                    <div class="col-md-6 mb-2 image-item" data-url="${imageUrl}">
                        <div class="card h-100">
                            <div class="position-relative">
                                <img src="${imageUrl}" class="card-img-top" style="height: 100px; object-fit: cover;" 
                                     onerror="this.src='/images/noimage.jpg'" loading="lazy">
                                <span class="position-absolute top-0 end-0 badge bg-success m-1 main-indicator" style="display: ${setAsMain ? 'block' : 'none'};">Ảnh chính</span>
                            </div>
                            <div class="card-body p-2">
                                <div class="form-check mb-1">
                                    <input class="form-check-input main-image" type="radio" name="MainImageUrl" value="${imageUrl}" ${setAsMain ? 'checked' : ''}>
                                    <label class="form-check-label small">Ảnh chính</label>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger remove-image w-100">
                                    <i class="fas fa-trash me-1"></i>Xóa
                                </button>
                            </div>
                        </div>
                    </div>
                `);
                
                imageContainer.append(imageItem);
                updateNoImagesMessage();
            }

            function updateMainImageIndicators() {
                console.log('Updating main image indicators...');
                $('.main-indicator').hide();
                var $checkedImage = $('.main-image:checked');
                console.log('Checked image:', $checkedImage.val());
                $checkedImage.closest('.image-item').find('.main-indicator').show();
            }

            function updateNoImagesMessage() {
                const hasImages = $('.image-item').length > 0;
                $('#noImagesMessage').toggleClass('d-none', hasImages);
            }

            function showAlert(message, type = 'info') {
                const alertClass = type === 'error' ? 'alert-danger' : 
                                  type === 'warning' ? 'alert-warning' : 
                                  type === 'success' ? 'alert-success' : 'alert-info';
                const alertHtml = `<div class="alert ${alertClass} alert-dismissible fade show temp-alert" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`;
                
                $('.temp-alert').remove();
                $('#imagePreviewContainer').before(alertHtml);
                
                setTimeout(() => $('.temp-alert').fadeOut(), 5000);
            }

            // Xử lý form submit
            $('#addEditProductForm').off('submit').on('submit', function(e) {
                e.preventDefault();
                e.stopImmediatePropagation();
                
                const $form = $(this);
                const $submitBtn = $form.find('button[type="submit"]');
                
                if ($submitBtn.prop('disabled') || $form.data('submitting')) {
                    return false;
                }
                
                if (!this.checkValidity()) {
                    e.stopPropagation();
                    $form.addClass('was-validated');
                    return false;
                }
                
                $form.data('submitting', true);
                
                // Ensure there's a main image selected
                if ($('.image-item').length > 0) {
                    if ($('.main-image:checked').length === 0) {
                        $('.main-image').first().prop('checked', true);
                    }
                    // Update the main image indicators
                    updateMainImageIndicators();
                }
                
                const originalText = $submitBtn.html();
                $submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Đang lưu...');
                
                const formData = new FormData(this);
                
                // Debug: Log form data
                console.log('=== FORM DATA DEBUG ===');
                console.log('MainImageUrl:', formData.get('MainImageUrl'));
                console.log('ExistingImages:', formData.getAll('ExistingImages'));
                console.log('ImageFiles count:', formData.getAll('ImageFiles').filter(f => f.size > 0).length);
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    timeout: 30000,
                    success: function(response) {
                        if (response.success) {
                            showAlert('Lưu sản phẩm thành công!', 'success');
                            setTimeout(() => {
                                window.location.href = '@Url.Action("Index", "Sanpham", new { area = "Admin" })';
                            }, 1000);
                        } else {
                            showAlert(response.message || 'Không thể lưu sản phẩm', 'error');
                        }
                    },
                    error: function(xhr, textStatus) {
                        let errorMsg = 'Lỗi kết nối. Vui lòng thử lại.';
                        if (textStatus === 'timeout') {
                            errorMsg = 'Yêu cầu quá thời gian chờ. Vui lòng thử lại.';
                        } else if (xhr.responseJSON?.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        showAlert(errorMsg, 'error');
                    },
                    complete: function() {
                        $form.data('submitting', false);
                        $submitBtn.prop('disabled', false).html(originalText);
                    }
                });
                
                return false;
            });
            
            function loadThanhPhanForProduct() {
                var productId = $('input[name="IdSanPham"]').val() || 0;
                
                $('#thanhPhanContainer').html('<div class="text-center py-2"><small class="text-muted">Đang tải...</small></div>');
                
                $.get(window.productUrls.getThanhPhanForProduct, { productId: productId })
                    .done(function(response) {
                        if (response.success) {
                            var html = '';
                            if (response.data && response.data.length > 0) {
                                response.data.forEach(function(item) {
                                    html += `
                                        <div class="form-check mb-1 thanhphan-item" data-name="${item.ten.toLowerCase()}">
                                            <input class="form-check-input thanhphan-checkbox" type="checkbox" 
                                                   value="${item.id}" id="thanhphan_${item.id}" 
                                                   ${item.isSelected ? 'checked' : ''}
                                                   name="ThanhPhanIds">
                                            <label class="form-check-label" for="thanhphan_${item.id}">
                                                <strong>${item.ten}</strong>
                                            </label>
                                        </div>
                                    `;
                                });
                            } else {
                                html = '<div class="text-center py-2"><small class="text-muted">Chưa có thành phần nào.</small></div>';
                            }
                            $('#thanhPhanContainer').html(html);
                        } else {
                            $('#thanhPhanContainer').html('<div class="alert alert-warning">Không thể tải danh sách thành phần.</div>');
                        }
                    })
                    .fail(function() {
                        $('#thanhPhanContainer').html('<div class="alert alert-danger">Lỗi kết nối khi tải thành phần.</div>');
                    });
            }
            
            // Xử lý tìm kiếm thành phần
            $('#searchThanhPhan').on('input', function() {
                var searchText = $(this).val().toLowerCase().trim();
                
                if (searchText === '') {
                    // Hiện tất cả
                    $('.thanhphan-item').show();
                } else {
                    // Lọc theo tên
                    $('.thanhphan-item').each(function() {
                        var itemName = $(this).data('name');
                        if (itemName.includes(searchText)) {
                            $(this).show();
                        } else {
                            $(this).hide();
                        }
                    });
                }
                
                // Hiển thị thông báo nếu không tìm thấy
                var visibleItems = $('.thanhphan-item:visible').length;
                var $noResultMsg = $('#thanhPhanContainer .no-results');
                
                if (visibleItems === 0 && searchText !== '') {
                    if ($noResultMsg.length === 0) {
                        $('#thanhPhanContainer').append('<div class="no-results text-center py-2"><small class="text-muted">Không tìm thấy thành phần phù hợp</small></div>');
                    }
                } else {
                    $noResultMsg.remove();
                }
            });

            // Thêm nhanh thành phần
            $('#quickAddThanhPhanBtn').on('click', function(e) {
                e.preventDefault();
                const name = ($('#newThanhPhanName').val() || '').trim();
                if (!name) {
                    showAlert('Vui lòng nhập tên thành phần.', 'warning');
                    $('#newThanhPhanName').focus();
                    return;
                }
                const $btn = $(this);
                const html = $btn.html();
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Đang thêm...');
                $.ajax({
                    url: window.productUrls.addOrEditThanhPhan,
                    type: 'POST',
                    data: {
                        IdThanhPhan: 0,
                        TenThanhPhan: name,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    }
                }).done(function(res){
                    if (res.success) {
                        showAlert('Thêm thành phần thành công!', 'success');
                        $('#newThanhPhanName').val('');
                        loadThanhPhanForProduct();
                        // Tự động tick thành phần vừa thêm sau khi danh sách tải xong
                        setTimeout(function(){
                            const lname = name.toLowerCase();
                            $('.thanhphan-item').each(function(){
                                if ($(this).data('name') === lname) {
                                    $(this).find('input[type="checkbox"]').prop('checked', true);
                                }
                            });
                        }, 600);
                    } else {
                        showAlert(res.message || 'Không thể thêm thành phần.', 'error');
                    }
                }).fail(function(){
                    showAlert('Lỗi kết nối khi thêm thành phần.', 'error');
                }).always(function(){
                    $btn.prop('disabled', false).html(html);
                });
            });

            // Thêm nhanh thuộc tính
            $('#quickAddThuocTinhBtn').on('click', function(e){
                e.preventDefault();
                const name = ($('#newThuocTinhName').val() || '').trim();
                if (!name) {
                    showAlert('Vui lòng nhập tên thuộc tính.', 'warning');
                    $('#newThuocTinhName').focus();
                    return;
                }
                const $btn = $(this);
                const html = $btn.html();
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Đang thêm...');
                $.ajax({
                    url: window.productUrls.addAttribute,
                    type: 'POST',
                    data: {
                        tenThuocTinh: name,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    }
                }).done(function(res){
                    if (res.success) {
                        showAlert('Thêm thuộc tính thành công!', 'success');
                        $('#newThuocTinhName').val('');
                        // Bổ sung thuộc tính mới vào dropdown để thêm giá trị ngay
                        if (res.data && res.data.idThuocTinh && res.data.tenThuocTinh) {
                            const $sel = $('#selectThuocTinh');
                            const exists = $sel.find('option').filter(function(){ return $(this).val() == String(res.data.idThuocTinh); }).length > 0;
                            if (!exists) {
                                $sel.append(`<option value="${res.data.idThuocTinh}">${res.data.tenThuocTinh}</option>`);
                            }
                            $sel.val(String(res.data.idThuocTinh));
                            $('#newGiaTriText').focus();
                        }
                        // Tải lại danh sách thuộc tính và giá trị
                        loadAttributesWithValues();
                    } else {
                        showAlert(res.message || 'Không thể thêm thuộc tính.', 'error');
                    }
                }).fail(function(){
                    showAlert('Lỗi kết nối khi thêm thuộc tính.', 'error');
                }).always(function(){
                    $btn.prop('disabled', false).html(html);
                });
            });

            // Thêm nhanh giá trị thuộc tính
            $('#quickAddGiaTriBtn').on('click', function(e){
                e.preventDefault();
                const attrId = parseInt($('#selectThuocTinh').val() || '0');
                const values = ($('#newGiaTriText').val() || '').trim();
                if (!attrId) {
                    showAlert('Vui lòng chọn thuộc tính.', 'warning');
                    $('#selectThuocTinh').focus();
                    return;
                }
                if (!values) {
                    showAlert('Vui lòng nhập giá trị (có thể nhập nhiều, cách nhau bằng dấu phẩy).', 'warning');
                    $('#newGiaTriText').focus();
                    return;
                }
                const $btn = $(this);
                const html = $btn.html();
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Đang thêm...');
                $.ajax({
                    url: window.productUrls.addAttributeValue,
                    type: 'POST',
                    data: {
                        idThuocTinh: attrId,
                        giaTri: values,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    }
                }).done(function(res){
                    if (res.success) {
                        showAlert(res.message || 'Đã thêm giá trị thuộc tính!', 'success');
                        $('#newGiaTriText').val('');
                        // Tải lại danh sách thuộc tính và giá trị
                        loadAttributesWithValues();
                    } else {
                        showAlert(res.message || 'Không thể thêm giá trị.', 'error');
                    }
                }).fail(function(){
                    showAlert('Lỗi kết nối khi thêm giá trị.', 'error');
                }).always(function(){
                    $btn.prop('disabled', false).html(html);
                });
            });

            // Load và hiển thị danh sách thuộc tính với giá trị
            function loadAttributesWithValues() {
                $('#attributeValuesDisplay').html('<div class="text-center py-2"><small class="text-muted">Đang tải...</small></div>');
                
                $.get(window.productUrls.getAttributesWithValues)
                    .done(function(response) {
                        if (response.success && response.data) {
                            let html = '';
                            if (response.data.length > 0) {
                                response.data.forEach(function(attr) {
                                    html += `<div class="mb-2">
                                        <strong class="text-primary">${attr.tenThuocTinh}</strong>
                                        <div class="mt-1">`;
                                    
                                    if (attr.giaTriList && attr.giaTriList.length > 0) {
                                        attr.giaTriList.forEach(function(val) {
                                            html += `<span class="badge bg-light text-dark border me-1 mb-1">${val.giaTri}</span>`;
                                        });
                                    } else {
                                        html += `<small class="text-muted fst-italic">Chưa có giá trị</small>`;
                                    }
                                    
                                    html += `</div></div>`;
                                });
                            } else {
                                html = '<div class="text-center py-2"><small class="text-muted">Chưa có thuộc tính nào. Hãy thêm thuộc tính ở trên.</small></div>';
                            }
                            $('#attributeValuesDisplay').html(html);
                        } else {
                            $('#attributeValuesDisplay').html('<div class="alert alert-warning mb-0">Không thể tải danh sách thuộc tính.</div>');
                        }
                    })
                    .fail(function() {
                        $('#attributeValuesDisplay').html('<div class="alert alert-danger mb-0">Lỗi kết nối khi tải thuộc tính.</div>');
                    });
            }

            // ===== SLUG MANAGEMENT =====
            // Function để chuyển đổi tiếng Việt sang slug
            function generateSlugFromText(text) {
                if (!text) return '';
                
                // Chuyển thành chữ thường
                let slug = text.toLowerCase().trim();
                
                // Bảng chuyển đổi tiếng Việt
                const vietnameseMap = {
                    'à': 'a', 'á': 'a', 'ả': 'a', 'ã': 'a', 'ạ': 'a',
                    'ă': 'a', 'ằ': 'a', 'ắ': 'a', 'ẳ': 'a', 'ẵ': 'a', 'ặ': 'a',
                    'â': 'a', 'ầ': 'a', 'ấ': 'a', 'ẩ': 'a', 'ẫ': 'a', 'ậ': 'a',
                    'đ': 'd',
                    'è': 'e', 'é': 'e', 'ẻ': 'e', 'ẽ': 'e', 'ẹ': 'e',
                    'ê': 'e', 'ề': 'e', 'ế': 'e', 'ể': 'e', 'ễ': 'e', 'ệ': 'e',
                    'ì': 'i', 'í': 'i', 'ỉ': 'i', 'ĩ': 'i', 'ị': 'i',
                    'ò': 'o', 'ó': 'o', 'ỏ': 'o', 'õ': 'o', 'ọ': 'o',
                    'ô': 'o', 'ồ': 'o', 'ố': 'o', 'ổ': 'o', 'ỗ': 'o', 'ộ': 'o',
                    'ơ': 'o', 'ờ': 'o', 'ớ': 'o', 'ở': 'o', 'ỡ': 'o', 'ợ': 'o',
                    'ù': 'u', 'ú': 'u', 'ủ': 'u', 'ũ': 'u', 'ụ': 'u',
                    'ư': 'u', 'ừ': 'u', 'ứ': 'u', 'ử': 'u', 'ữ': 'u', 'ự': 'u',
                    'ỳ': 'y', 'ý': 'y', 'ỷ': 'y', 'ỹ': 'y', 'ỵ': 'y'
                };
                
                // Thay thế ký tự tiếng Việt
                for (let char in vietnameseMap) {
                    slug = slug.replace(new RegExp(char, 'g'), vietnameseMap[char]);
                }
                
                // Loại bỏ các ký tự đặc biệt, chỉ giữ chữ cái, số và khoảng trắng
                slug = slug.replace(/[^a-z0-9\s-]/g, '');
                
                // Thay thế nhiều khoảng trắng bằng một khoảng trắng
                slug = slug.replace(/\s+/g, ' ');
                
                // Thay thế khoảng trắng bằng dấu gạch ngang
                slug = slug.replace(/\s/g, '-');
                
                // Loại bỏ các dấu gạch ngang liên tiếp
                slug = slug.replace(/-+/g, '-');
                
                // Loại bỏ dấu gạch ngang ở đầu và cuối
                slug = slug.trim('-');
                
                return slug;
            }

            // Nút tạo slug từ tên sản phẩm
            $('#btnGenerateSlug').on('click', function() {
                const tenSanPham = $('#tenSanPham').val();
                if (!tenSanPham) {
                    showAlert('Vui lòng nhập tên sản phẩm trước!', 'warning');
                    $('#tenSanPham').focus();
                    return;
                }
                
                const newSlug = generateSlugFromText(tenSanPham);
                $('#slug').val(newSlug);
                validateSlug(newSlug);
            });

            // Validate slug khi người dùng nhập
            let slugTimeout;
            $('#slug').on('input', function() {
                clearTimeout(slugTimeout);
                const slug = $(this).val();
                
                // Auto-format slug
                const formattedSlug = slug.toLowerCase().replace(/[^a-z0-9-]/g, '');
                if (slug !== formattedSlug) {
                    $(this).val(formattedSlug);
                }
                
                slugTimeout = setTimeout(() => {
                    validateSlug(formattedSlug);
                }, 500);
            });

            // Kiểm tra slug có bị trùng không
            function validateSlug(slug) {
                const $validation = $('#slugValidation');
                
                if (!slug) {
                    $validation.html('<small class="text-danger">Slug không được để trống</small>');
                    return false;
                }
                
                if (slug.length < 3) {
                    $validation.html('<small class="text-warning">Slug nên có ít nhất 3 ký tự</small>');
                    return false;
                }
                
                $validation.html('<small class="text-muted"><i class="fas fa-spinner fa-spin"></i> Đang kiểm tra...</small>');
                
                $.ajax({
                    url: '@Url.Action("CheckSlugExists", "Sanpham", new { area = "Admin" })',
                    type: 'GET',
                    data: { 
                        slug: slug,
                        productId: @(Model.IdSanPham)
                    }
                }).done(function(result) {
                    if (result.exists) {
                        $validation.html('<small class="text-danger"><i class="fas fa-times-circle"></i> Slug đã tồn tại, vui lòng chọn slug khác!</small>');
                    } else {
                        $validation.html('<small class="text-success"><i class="fas fa-check-circle"></i> Slug hợp lệ và có thể sử dụng</small>');
                    }
                }).fail(function() {
                    $validation.html('<small class="text-warning">Không thể kiểm tra slug</small>');
                });
            }

            // Tự động tạo slug khi tạo sản phẩm mới và tên sản phẩm thay đổi
            @if (isNewProduct)
            {
                <text>
                $('#tenSanPham').on('blur', function() {
                    const currentSlug = $('#slug').val();
                    if (!currentSlug) {
                        const tenSanPham = $(this).val();
                        if (tenSanPham) {
                            const newSlug = generateSlugFromText(tenSanPham);
                            $('#slug').val(newSlug);
                            validateSlug(newSlug);
                        }
                    }
                });
                </text>
            }

            // Validate slug trước khi submit
            $('#addEditProductForm').on('submit', function(e) {
                const slug = $('#slug').val();
                if (!slug || slug.length < 3) {
                    e.preventDefault();
                    showAlert('Vui lòng nhập slug hợp lệ (ít nhất 3 ký tự)!', 'error');
                    $('#slug').focus();
                    return false;
                }
            });

            // Initialize tooltip
            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    </script>
}
